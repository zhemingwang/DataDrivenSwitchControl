using LinearAlgebra
using DynamicPolynomials
using SwitchOnSafety
using Combinatorics
using SparseArrays
using JuMP, Ipopt, MosekTools,NLopt
using SpecialFunctions
using ControlSystems



include("../src/RandomTrajectories.jl")
include("../src/AlgebraicLift.jl")
include("../src/ScenarioOpti.jl")
include("../src/ProbabilisticCertificates.jl")
include("../src/WhiteBoxAnalysis.jl")

#=
xi sequence: Any[0.9683156250414907]
ratio sequence: Any[-1.656983025281051]
K: [-0.3248747870659423 -0.19627406790980864 -0.2115208138915541; -0.19751648680449582 -0.32369931645693906 -0.20977918657675867; -0.20859827534951245 -0.21086955584166633 -0.30040411143634854]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1972013376422748 0.9340268167010367 0.9677855847307597; 0.9340268167010367 2.19647349124049 0.9677617968093439; 0.9677855847307597 0.9677617968093439 2.1204510727977146]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074]
K: [-0.32462978106823676 -0.19670191591264238 -0.21229676900765326; -0.19780423662953137 -0.3237098829951 -0.21006048415983786; -0.20969857379842968 -0.21092864571511888 -0.3005036770682926]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1990268930931602 0.9363043600157323 0.9699468958663795; 0.9363043600157323 2.1991228784298364 0.9699661880988761; 0.9699468958663795 0.9699661880988761 2.1231772898023005]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276]
K: [-0.3238826779786298 -0.19536055763297963 -0.21033415881740258; -0.1965136584223069 -0.3229598786421959 -0.20927862665622693; -0.20774999857351267 -0.20977541207466754 -0.29937543550356416]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1924254729456356 0.9303426427173346 0.9640115452018985; 0.9303426427173346 2.1924317392413015 0.9640339625769482; 0.9640115452018985 0.9640339625769482 2.1166560285181686]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653]
K: [-0.3237068809358526 -0.19536728061544453 -0.2103462318731004; -0.19648069248445024 -0.32283443648004684 -0.20918117423530977; -0.20772980296676163 -0.20966616379661215 -0.29923678054265485]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.192062366093903 0.9300468707981729 0.9637001196032168; 0.9300468707981729 2.192067826259948 0.9637201137040298; 0.9637001196032168 0.9637201137040298 2.116345801056024]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315]
K: [-0.3237274070001396 -0.19538130952972665 -0.21033845105806426; -0.19639770058129094 -0.3229142264358349 -0.209316118129586; -0.20784168945296205 -0.2096003750954954 -0.2991328747967827]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.19212774873239 0.9300974161440879 0.9637537856667788; 0.9300974161440879 2.1921265358375575 0.9637734996024601; 0.9637537856667788 0.9637734996024601 2.1163979304176253]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799]
K: [-0.3237049186501524 -0.19542302171281786 -0.21038178276116257; -0.19643991723873253 -0.32290329903019926 -0.20928435415155974; -0.20785010102074641 -0.20960075594657251 -0.299151080435559]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1921722746775254 0.9301364937415721 0.9637916885075064; 0.9301364937415721 2.192169350600342 0.9638117874634714; 0.9637916885075064 0.9638117874634714 2.1164414689195277]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052]
K: [-0.3237522893677747 -0.19536580714754553 -0.21040321655856303; -0.19639745686570487 -0.32293954028128574 -0.20927844699888765; -0.20783915692714536 -0.20962397698113008 -0.29914155323706243]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.192180475182962 0.9301246715853033 0.9637955537049163; 0.9301246715853033 2.1921868381800027 0.9638116128434447; 0.9637955537049163 0.9638116128434447 2.1164239523354484]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461]
K: [-0.3228604948857882 -0.19549487698343607 -0.2108312617640421; -0.19598552623233648 -0.32192638533066065 -0.20888910867279023; -0.20817323658447529 -0.20930569592156534 -0.2982013849059641]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1912079112248866 0.9293243883329915 0.962929078914566; 0.9293243883329915 2.191145299431057 0.9629482743344887; 0.962929078914566 0.9629482743344887 2.1155963563486924]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679]        
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025] 
K: [-0.32276512778378014 -0.19536076031064206 -0.2107439278360915; -0.19590257297766198 -0.3217826398807589 -0.20870295485593057; -0.20797802866892978 -0.20920603385068368 -0.29809750536372387]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1904858308272575 0.9286909375476097 0.9622874944356845; 0.9286909375476097 2.1904228857495776 0.9623069576423308; 0.9622874944356845 0.9623069576423308 2.1149099939315232]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679, 0.9695633488243481]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025, 
0.6748046259174563]
K: [-0.32269329861389284 -0.19522645103557376 -0.21060895954370115; -0.195659083794489 -0.32198492028259085 -0.20911283860243865; -0.20821953765543227 -0.20915911267617338 -0.2978104989005386]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1903866031026644 0.9285887616225481 0.9621794975794067; 0.9285887616225481 2.190312889748258 0.9621956116949331; 0.9621794975794067 0.9621956116949331 2.114801606080151]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679, 0.9695633488243481, 0.9695614624901595]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025, 
0.6748046259174563, 0.7019955824786718]
K: [-0.32278598079864856 -0.19515671055450798 -0.2105696479469469; -0.19611026628872094 -0.32190271680445337 -0.20860276896020685; -0.20777318188397928 -0.20941960012862665 -0.29836495788902]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.190396090371549 0.9285957536898113 0.9621875969728081; 0.9285957536898113 2.1903254428414702 0.9622067204263213; 0.9621875969728081 0.9622067204263213 2.1148123603137616]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679, 0.9695633488243481, 0.9695614624901595, 0.969574198644117]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025, 
0.6748046259174563, 0.7019955824786718, 0.7251872802340846]
K: [-0.3228596955744929 -0.19528557098981414 -0.21057341283170242; -0.19586005034503381 -0.3220628658943742 -0.20895810205247192; -0.20796473286949535 -0.20920611430461805 -0.2980939924080248]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.190310623453163 0.9285638414216645 0.9621341809390067; 0.9285638414216645 2.1902402801392356 0.9621504265397797; 0.9621341809390067 0.9621504265397797 2.1147883565655046]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679, 0.9695633488243481, 0.9695614624901595, 0.969574198644117, 0.9695337315643986]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025, 
0.6748046259174563, 0.7019955824786718, 0.7251872802340846, 0.7448815000734506]
K: [-0.32283723826278937 -0.19511341875788754 -0.2106150841702105; -0.19577168954304242 -0.3222132548739889 -0.20915537117609792; -0.20815265387287993 -0.20930774542946898 -0.2979487862288683]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.190515009724325 0.9287444906399456 0.9623159692055974; 0.9287444906399456 2.190446775807438 0.9623306688453478; 0.9623159692055974 0.9623306688453478 2.114983841916753]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]

xi sequence: Any[0.9683156250414907, 0.9678490125230486, 0.9691620647938736, 0.9692312586611147, 0.9692194409997862, 0.9692107465982519, 0.9692104967934825, 0.9694003530964922, 0.9695422533919679, 0.9695633488243481, 0.9695614624901595, 0.969574198644117, 0.9695337315643986, 0.9698435676498646]
ratio sequence: Any[-1.656983025281051, -0.4244545611023074, 0.01491742087756276, 0.24274806144579653, 0.38286000512642315, 0.4780200524241799, 0.5470220647879052, 0.6001214894617461, 0.6413576530196025, 
0.6748046259174563, 0.7019955824786718, 0.7251872802340846, 0.7448815000734506, 0.7617640538688649]
K: [-0.32243923217838516 -0.1947257432971728 -0.21027529340438042; -0.19577838100302694 -0.32166754081149557 -0.2083821336262491; -0.20752961700996445 -0.20919019168381428 -0.29799969821148625]
K white-box: [-0.2867753880734422 -0.1677914982897813 -0.181163043688666; -0.16779032708480757 -0.2867763524261141 -0.18116445876517218; -0.17874008945790426 -0.17873809663518472 -0.2631285409149983]     
P: [2.1889413170139846 0.9273614498627059 0.9609167062685116; 0.9273614498627059 2.1888741022712463 0.9609342580610728; 0.9609167062685116 0.9609342580610728 2.1134858574685444]
P white-box: [2.0467643528040194 0.8031161732813292 0.8350483292807329; 0.8031161732813294 2.046763963818907 0.8350483168061293; 0.8350483292807328 0.8350483168061293 1.978342590393598]
=#


dim = 3; numMode = 4; dimIn = 3

numScen_budget = 25000

c = 1375
R12 = 1.5
Ro12 = 3
Ro3 = 2.7
tau = 3*60
A = []
for R13 in [0.8 1.2]
    for R23 in [0.8 1.2]
        Ai = [1-tau/c*(1/R12+1/R13+1/Ro12) tau/c/R12 tau/c/R13;tau/c/R12 1-tau/c*(1/R12+1/R23+1/Ro12) tau/c/R23;tau/c/R13 tau/c/R23 1-tau/c*(1/R13+1/R23+1/Ro3)]
        push!(A,Ai)
    end
end

B = tau/c*Matrix(I,dimIn,dimIn)


Q = Matrix(I,dim,dim)
R = 0.02*Matrix(I,dimIn,dimIn)

(K,P) = white_box_LQR(A,B,Q,R)
println("K white-box: $K")
println("P white-box: $P")


ratiosq = []
for N in 1000:1000:25000
    ep = beta2epsilon(0.01,dim,numMode,N)
    Z = P-Q-K'*R*K
    eigZ = eigvals(Z)
    ratio = 1-(maximum(eigZ)/minimum(eigZ))*(1-cos(delta2theta(ep,dim)))
    push!(ratiosq,ratio)
    println("ratio sequence: $ratiosq")
    println(maximum(eigZ)/minimum(eigZ))
end


#=
state = [15;10;12]
X = zeros(dim,10)
for i in 1:10
    global state
    X[:,i] = state
    b = rand((1:numMode),1)
    u = K*state
    state = A[b[1]]*state+B*u
    println("control: $u")
end

X = X.+24

gr(size = (400, 300))
fn = plot(0:3:9*3, Any[X[1,:],X[2,:],X[3,:]],label = ["Zone 1" "Zone 2" "Zone 3"], line = [:solid :solid :solid], lw = 2)
xlabel!("Time (minute)")
ylabel!("Temperature (°C) ")
savefig(fn,"fn.png")
=#






























