using LinearAlgebra
using DynamicPolynomials
using SwitchOnSafety
using Combinatorics
using SparseArrays
using JuMP, Ipopt, MosekTools,NLopt
using SpecialFunctions




include("../src/RandomTrajectories.jl")
include("../src/AlgebraicLift.jl")
include("../src/ScenarioOpti.jl")
include("../src/ProbabilisticCertificates.jl")
include("../src/WhiteBoxAnalysis.jl")



dim = 2; numMode = 2; dimIn = 1

numScen_budget = 1000

Asave = [zeros(Float64, (dim, dim)) for i=1:numMode]
Bsave = zeros(Float64, (dim, dimIn))
ratio = 1


while true

A = [2*rand(Float64, (dim, dim)).-1 for i=1:numMode]
#A = [[1 1; 0 1], [1 0; 1 1]]
#println(A)
jsrbound = white_box_jsr(A)

#println("JSR: $jsrbound")

rhomax = 0
for i in 1:numMode
    rhoA = maximum(abs.(eigvals(A[i])))
    if rhomax < rhoA
        rhomax = rhoA
    end
end
#println("Eigenvalue max: $rhomax")

if jsrbound > 1 #rhomax < jsrbound*0.9 && 


B = 2*rand(Float64, (dim, dimIn)).-1
gaTrue,K = white_box_stabilization_quad(A,B)
#println(K)
if isempty(K)
    println("A: $A")
    println("B: $B")
end
jsrboundclosed = white_box_jsr([Ai+B*K for Ai in A])

if gaTrue/jsrboundclosed > ratio
    global Asave = A 
    global Bsave = B
    global ratio = gaTrue/jsrboundclosed
    println("White-box stabilization: $gaTrue")
    println("JSR closed: $jsrboundclosed")
    println("A: $Asave")
    println("B: $Bsave")
    println("Ratio: $ratio")
end




#=
AK = [Ai+B*K for Ai in A]
rhomax_close = 0
for i in 1:numMode
    rhoA = maximum(abs.(eigvals(AK[i])))
    if rhomax_close < rhoA
        rhomax_close = rhoA
    end
end
println("Eigenvalue max closed: $rhomax_close")
=#
if jsrboundclosed < gaTrue*0.9 #jsrboundclosed > 1 && 

    println("White-box stabilization: $gaTrue")
    println("JSR closed: $jsrboundclosed")
    println("A: $A")
    println("B: $B")


#=
gamma1: 1.091098994365357 || K1: [0.4450968546375577 -0.0067944232635188 -0.07242928507366847; -1.0901373033935469 -0.6362471475237879 -0.6546310496281078]
gamma2: 1.0043051965701504 || K2: [-0.017481932047868836 -0.019322752052078965 -0.13267775176698232; -0.16816570986167362 -0.16848413512732924 -0.1473949009786114]
gamma3: 0.9319170550393475 || K3: [0.2185895965435866 0.0828529524089513 -0.10940266352022417; -0.4330159942259682 -0.2689004267861104 -0.36664805316411]
A: [[-0.035713556139526315 -0.46101936337212224 0.5758464004636243; 0.5365323737379186 -0.4238668271399051 -0.15898425119264026; 0.8419591377106763 -0.12433448826055438 0.08762970902198686], [0.7536818225043662 0.8448230972467972 -0.5723985482099347; -0.01764965739578206 -0.726360371394331 0.919109231975153; -0.7616763202127323 -0.45233767277561787 0.8890705069340319], [0.9675539515043958 0.33014694100762054 0.7845206390342243; -0.7664059406402712 -1.4599068229700047 -1.374238975340281; -0.9919933573988242 0.032139509230417085 -0.7241320070196489]]
B: [-0.9738898776106395 0.2430937821271404; -0.5594898459836832 -0.8567879128803524; 0.968034729630463 0.23321416718508736]


gamma1: 1.4771721521387928 || K1: [1.5837457868149079 -0.4143607875557178 -0.8926641693341837; 2.2458480283900912 -0.49739409437647436 0.12379794005429769]
gamma2: 1.1284125028892853 || K2: [1.169458826476936 1.0133947633814673 -0.483014379311149; 2.141282305221211 0.557871222870866 0.4928558882834438]
gamma3: 0.9586177379188866 || K3: [1.4852632106087928 0.768086923841151 -0.7357944137203406; 2.569449416459834 1.45216594818393 -0.6464578631991]
A: [[0.30711010163057084 0.35743471478281297 -0.4165467097338529; -1.2090478525084418 -1.0889753204734136 0.6606482717761146; 1.4916720938947043 0.712750594788254 -0.9494855947533352], [0.07478000105066651 1.2354131020593702 1.3717629013640442; -0.800207539428841 -1.2193833745904425 0.6737888109652435; 0.833849823841502 0.5815076492256317 0.31055833688134005], [0.43205427033385724 -1.2518407274846475 1.285786041398043; -0.8350914889424306 1.3566196051386124 0.5088045250037383; 1.0077852528903604 1.4886588615734646 1.2656260379533943]]
B: [0.8021437835254663 -0.6833724710101055; 0.6501895221291156 -0.07049181782485858; 0.2859499732121846 -0.6349752471957584]

gamma1: 1.018066677187341 || K1: [2.584474642796141 -0.24162143938208935 0.099462950616573; -1.2867193442164662 0.13807898609460512 -0.19437308433321066]
gamma2: 0.9832197222746352 || K2: [1.1463420634669867 -0.3221344185415759 -0.43056835102089497; -0.510805330235787 0.16847443653003535 0.09598776622354863]
gamma3: 0.9253726445472554 || K3: [0.4026290483392731 0.3331629002414559 -0.4362828807087034; -0.16661137825136454 -0.2450569921574039 0.12637508003535894]
A: [[-0.30800169258330756 0.9505145074280321 -0.6259941895718011; -0.09813858442579693 0.04701685427672242 0.47999535937466775; -0.5337119123653387 -1.22263351642073 1.0250969836175772], [-0.7760395797649433 
0.44231108160967914 -0.7322470977044158; -1.0076425423418636 0.8040581854952427 0.36770750935111374; -1.2752392250900568 0.1577843128284635 -0.04355988747606543], [0.8510269920574687 -0.7025377021362369 0.3662889318400304; -1.2401443442753204 0.5192000830316674 -0.8306209038179504; -1.308005763363062 0.8883944328469036 -0.7044580923902992]]
B: [-0.673706431037024 -0.9942210379640635; 0.5887891646350618 0.816544078417563; 0.5846952620521035 -0.08410769825592324]

gamma1: 1.2655581866366972 || K1: [-0.7523606179678266 -0.313855132517474 -0.18146019093303392; -1.598699415329922 0.40263117664776193 0.14878090883819198]
gamma2: 0.9418593783946065 || K2: [-1.1860831186635448 0.2616062380247517 -0.8299427094969802; -1.1238095874215457 0.43745239624058097 0.016050395816995855]
gamma3: 0.8821086726589813 || K3: [-0.8968314046121041 -0.14999943896045986 -0.6103608545100961; -1.1547588693711313 -0.33652194601647034 0.49950344977932337]
A: [[1.0595043843018859 -0.6438627791708056 0.00723522344691041; 0.2583554978549165 0.06987763899547095 -0.8988079061161514; -0.289275086715185 0.2213995411678067 -1.289514635518868], [-0.07381204441025302 0.194844991033865 -0.2028082999442229; -1.450850561219815 -0.7939044396088417 -0.22192956007240272; 0.6725331583952081 -1.449399767981382 0.08236411024717127], [1.4015273027335442 -1.4414767057887359 0.16407460676712216; 1.1077681042753422 -1.4266521231371279 -0.6003075175361281; -0.1589603499259864 0.9127473107730948 -1.0781043037842029]]
B: [0.1296346994002282 0.16628258052872047; -0.8117363096670669 0.12530345308656266; -0.8660337247723389 0.6781414601703961]


gamma1: 1.100564798387133 || K1: [-0.4754988921219234 0.9686501257953164]
gamma2: 0.9659557480414829 || K2: [-0.5608615591223438 0.6780315365664531]
A: [[1.2151079530621365 -0.33531513729513973; 1.2900511328638773 -1.3708985625995862], [-0.3408550384526632 -1.4962998078843397; 0.6784775763322353 -0.5621789240840522]]
B: [1.2212436025566022; 1.2344115037249868]

gamma1: 1.237023188862944 || K1: [1.6656380348300133 -1.5018804552577114]
gamma2: 0.8912866616247893 || K2: [1.2853564948996887 -0.9904177141477473]
A: [[-0.19602867727143058 0.9066579411992075; -1.191682425218234 -0.8165764607928059], [-1.4500928127989938 0.4987795138241713; -1.4907935439044315 0.13680174640346343]]
B: [0.5051340748481175; 0.35155906853515373]

White-box stabilization: 1.2515596315140356
gamma1: 1.21804211145584 || K1: [-0.49492771379150446 0.17138754707168224]
gamma2: 1.1025805507623097 || K2: [-0.8109269218012012 -0.22648847280226433]
A: [[0.5321293666918354 -1.4093176949123007; 0.3913118072170749 1.186645538188861], [-0.6346354185840684 0.4569919176747286; 0.9401935791262526 -0.4447425946384207]]
B: [0.48123383347242177; 0.6004781313788943]

White-box stabilization: 1.1252337292756291
gamma2: 0.9670755795170983 || K2: [-1.7872748458126402e-8 -1.2461763794928268e-7]
gamma1: 1.2610314995182843 || K1: [0.4979140858258914 -0.044031696357208806]
gamma2: 0.9670755795170983 || K2: [-1.7872748458126402e-8 -1.2461763794928268e-7]
A: [[1.1 0.0; 1.1 0.0], [0.0 1.1; 0.0 -1.1]]
B: [-0.9295420348363925; -0.7283669003038016]


********************************************************************************
White-box stabilization: 1.6996993773113758
JSR closed: 1.4442237715227517
JSR closed 1: 1.3356865279982715
JSR closed 2: 1.1956673430584541
********************************************************************************
gamma1: 1.3359320418484906 || K1: [0.9602082951808819 0.28190789741712763]
gamma2: 1.1972912108912892 || K2: [0.9473315633445621 0.4586615830219181]
A: [[0.299560690718218 0.9921279903594802; -0.5828937405932029 -1.4334283024388252], [-0.5717533245191793 0.9926090534389171; -1.0977155184013296 0.881840305882942]]
B: [0.6311748433573756; 0.9416093511508103]

White-box stabilization: 1.1572917246881822
JSR closed: 1.1572684714914292
JSR closed 1: 1.2200360005616773
JSR closed 2: 1.1606814421214997
JSR closed Prob1: 1.425911090191965
JSR closed Prob2: 1.343875912403204
********************************************************************************
jsr_bound1: 1.425911090191965 || K1: [-0.3509479741590583 0.6414243973390533]
jsr_bound2: 1.343875912403204 || K2: [-0.29654684439153317 0.02940580265883222]
A: [[0.8967668894523957 0.8591470561273686; -0.9947635042056926 0.052965678226623236], [-0.9304253310105608 0.8035784417559428; 0.28078770400919195 0.12841567064867432]]
B: [-0.3150204290150107; -0.7924848456311944]

A: [[-0.9658651798953035 0.3985096296438022; 0.4475503860449943 -0.45730946692696284], [0.30027599523474535 0.41190471605843415; 0.7561317624812265 0.6943226203170085]]
B: [0.7634030900512458; 0.7950504413443844]
Ratio: 1.0587283527849853

A: [[-0.9658651798953035 0.3985096296438022; 0.4475503860449943 -0.45730946692696284], [0.30027599523474535 0.41190471605843415; 0.7561317624812265 0.6943226203170085]]
B: [0.7634030900512458; 0.7950504413443844]
Ratio: 1.0587283527849853

A: [[0.8388521952671368 -0.14857670536251177; 0.8633807216781597 0.490362061793125], [0.6013596101878895 0.6697432384693109; -0.12770751192259544 0.9150610500819121]]
B: [0.9467520554779116; 0.20399193884377942]
Ratio: 1.1025338044487405

A: [[0.5688223165988293 -0.9319527689733245; 0.1382351159850712 0.9622194103015995], [0.6128965259152119 -0.3493383970117194; -0.6086026455428555 0.7983126792861888]]
B: [0.4470277518825365; 0.3302120500143886]
Ratio: 1.1230851016694519

A: [[-0.3551288408756461 -0.7687534611139699; 0.15585791034673502 0.888273516122466], [-0.5552855753806911 0.5799457932582954; -0.46463995630929 0.8225095618349383]]
B: [-0.9283359870409225; 0.054108218616240045]
Ratio: 1.1016410213969783

A: [[-0.8568628075440414 -0.5266755234199239; -0.8272553905086331 -0.6271478953810932], [-0.8939469134475648 -0.9649588910919555; 0.2625687202655267 0.6883472259929344]]
B: [-0.5860369597028803; 0.42375953316053083]
Ratio: 1.1009106556369916

A: [[0.901174622293865 -0.08869489383944629; 0.8269569776366761 0.993314713329033], [0.7936667657206211 0.9854194372202842; -0.06356358138135798 0.7352040314488115]]
B: [0.5927169628378124; -0.24484908800651395]
Ratio: 1.1189344932733898

A: [[0.9884483907628807 -0.7068091222615016; -0.9003002195090137 -0.990951516720938], [0.8310213698716118 -0.8061813540872644; 0.5209915287826292 -0.5808532982265562]]
B: [0.660211058916834; 0.011826520536278196]
Ratio: 1.0730366283985475

A: [[-0.7196693010722481 0.7362603872486089; 0.7329814217270463 0.09983056420902336], [-0.9755522690972618 -0.8955679827431435; 0.83195928316858 0.13739458769843527]]
B: [0.17446556981338768; 0.8261853369794627]
Ratio: 1.0970509881191342

A: [[0.27255516753923503 -0.30678093945243345; 0.27558866313527597 0.8715540933346464], [0.15704285284712594 0.09023848189832373; -0.917867260246092 0.867735961626027]]
B: [0.26096169679031345; 0.2655937741300747]
Ratio: 1.0856031657385525

A: [[-0.572890453958856 -0.7448127070893222; -0.544909303104943 -0.13907253647783913], [-0.16060049191299353 0.3285618812240414; -0.8284553971503263 0.9731152201540585]]
B: [0.23900251665502337; 0.38307159354825204]
Ratio: 1.0914956526368038


A: [[0.9862857830325393 -0.9628655906762353; 0.853552383240527 -0.44706514265408703], [0.931383926233575 -0.334587106156667; -0.35022364335672274 -0.46608495831363017]]
B: [0.30163279391747944; 0.9492599267898285]
Ratio: 1.111633220536938

A:  [-0.73239707473325 -0.7759541512450001; 0.6626624924274163 0.6554974407951288]
 [0.725630573905192 0.5301052861465569; 0.5809309408385976 -0.5621245111668207]
B:  0.9411913877449489
 0.4413303767850083
Ratio: 0.9

A: [[0.20944308830065594 0.28463112922261313; -0.6326970820092153 0.918521512555647], [-0.981039355084623 -0.6123453579379987; -0.043365051966182566 -0.13560416398363495]]
B: [0.2509068941663237; -0.5668162475328358]
Ratio: 0.953655145424864

A: [[0.3992966486009579 -0.8825975300456066; 0.9466203607162913 0.8220671916996221], [-0.05865322607237777 -0.32416336552150593; -0.5565696843656855 -0.8985422238439993]]
B: [-0.5919429619683738; 0.18179898964335361]
Ratio: 0.9817647067324977

A: [[0.20944308830065594 0.28463112922261313; -0.6326970820092153 0.918521512555647], [-0.981039355084623 -0.6123453579379987; -0.043365051966182566 -0.13560416398363495]]
B: [0.2509068941663237; -0.5668162475328358]
Ratio: 0.953655145424864


A: [[0.7218345749085846 0.013504049625046477; -0.763247200146052 0.823150250105976], [0.726724028000425 0.8385770769048322; -0.7232303846748045 0.19537267020502425]]
B: [0.11672890767112509; 0.4312206258057798]
Ratio: 0.9461275906687189

A: [[-0.8350343770388022 -0.006107458495185014; 1.6179435194682048 0.08247284108420949], [-0.5991942074864163 -1.7792515399993318; 1.1279527670550538 0.9404192977577894]]
B: [0.9917434505323639; 1.3179954593019438]
Ratio: 0.8497930947416346

A: [[0.94828677083526 -0.2101659042736399; 0.19875597778197385 -0.5455798309312145], [1.947971792726129 -1.970481262099395; -0.6161968652936665 0.27245749594569]]
B: [-1.2164941788317947; 0.5824551034488925]
Ratio: 0.7595095957585386

A: [[-3.204495329413295 4.309541104423182; -2.2814617881793997 -4.847416810806258], [-0.22831362951284184 1.4040030357725914; 2.026008926537825 -2.489778192500285]]
B: [-1.5225673231273773; 0.7036197784439802]
Ratio: 0.937374520680605

A: [[4.086417919490026 2.1723124078764178; -4.49798906103267 4.779648794298643], [2.5317508259661103 -4.6146818762012165; -1.8399429997449723 -4.957575716576564]]
B: [-1.7281795380537424; 4.595561599251386]
Ratio: 0.8658787049310742

A: [[1.2847752917460404 -4.294823846678941; 0.3680548348155881 0.014732983067902161], [1.1712220013664698 -0.8818060555034961; 1.6530187731608859 -2.3732736764432127]]
B: [0.32980020816855316; 2.992543632417817]
Ratio: 0.8364931366068367

A: [[-1.6253847837843716 3.595555954547308; 1.0345191229698347 1.5593831936113656], [-0.097076612905167 -4.262435989897899; 2.575877434237759 1.586551277526027]]
B: [0.468806484246338; 2.756260070416152]
Ratio: 0.8876232465445488

A: [[-2.486281431248263 4.907579862031962; 1.5579585224383834 -3.287845396063369], [-0.2529089238709137 -1.0602793211568318; 2.3880838078084636 4.924238633856245]]
B: [1.1435267881128874; 1.947585246102994]
Ratio: 0.7533669990528284
=#


(state0_budget,state_budget) = generate_trajectories(1,A,numScen_budget)


batchsize = numScen_budget

K0 = zeros(dimIn,dim)

K1,ga1,P1 = soslyap_alternating(state0_budget,state_budget;B=B,d=1,batchsize=batchsize,K0=K0,tol=1e-3)
println("gamma1: $ga1 || K1: $K1 ")
Aclose1 = [Ai+B*K1 for Ai in A]
jsrboundclose1 = white_box_jsr(Aclose1)
if abs(ga1-gaTrue) < 0.1

    #K2,jsr_bound2 = probabilistc_stability_certificate(state0_budget,state_budget;B=B,numMode=numMode,d=2,batchsize=1000,K0=K0,beta=0.1,tol=1e-3)
    K2,ga2,P2 = soslyap_alternating(state0_budget,state_budget;B=B,d=2,batchsize=batchsize,K0=K0,tol=1e-3)
    println("gamma2: $ga2 || K2: $K2")
    Aclose2 = [Ai+B*K2 for Ai in A]
    jsrboundclose2 = white_box_jsr(Aclose2)

    println(repeat('*', 80))
    println("White-box stabilization: $gaTrue")
    println("JSR closed: $jsrboundclosed")
    println("JSR closed 1: $jsrboundclose1")
    println("JSR closed 2: $jsrboundclose2")

    println("JSR closed Prob1: $ga1")
    println("JSR closed Prob2: $ga2")

    println(repeat('*', 80))

if ga2 < 0.9*ga1 #&& jsr_bound2 < 1
    println("jsr_bound1: $ga1 || K1: $K1 ")
    println("jsr_bound2: $ga2 || K2: $K2")
    println("A: $A")
    println("B: $B")
    break
end
end
end
end


end
